VERSION := 1.0.0
CC := gcc
AR := ar
OBJS := smq.o
LIB := libsmq
MANPAGE := $(LIB).3
TESTBINS = smq_test

PREFIX ?= $PREFIX
MANDIR ?= $MANDIR

CFLAGS += -Wall -Wextra -pedantic -Wshadow -Wpointer-arith -Wcast-align
CFLAGS += -Wwrite-strings -Wmissing-prototypes -Wmissing-declarations
CFLAGS += -Wnested-externs -Winline -Wno-long-long  -Wunused-variable
CFLAGS += -Wstrict-prototypes -Werror -ansi -I.
CFLAGS += -DVERSION="\"$(LIB) version $(VERSION)\""
CFLAGS += OS_CFLAGS
all: $(LIB).a man

$(LIB).a: $(OBJS)
	@echo "AR $@"
	@$(AR) -crs $@ $?

clean:
	-rm -f .*.* *.core *.o *.html tags $(TARGET) $(OBJS) *.plist
	-rm -rf $(LIB)-$(VERSION)
	-rm -f $(LIB)-$(VERSION).tgz

install: $(LIB).a man
	install -d $(PREFIX)/lib
	install $(LIB).a $(PREFIX)/lib/$(LIB).a
	install -m 0755 -d $(MANDIR)/man3
	install -m 0444 $(MANPAGE) $(MANDIR)/man1/$(MANPAGE)

uninstall:
	-rm -f $(PREFIX)/lib/$()
	-rm -f $(MANDIR)/man3/$(MANPAGE)

test: $(TESTBINS)

smq_test: smq_test.o $(LIB).a
	@echo "LD $@"
	@$(CC) $(CFLAGS) -o $@ $@.o -lpthread -L. -lsmq

audit: 
	rats -i -w3 *.[ch]
	flawfinder *.[ch]
	make $(OBJS) CC="clang" CFLAGS="$(CFLAGS) --analyze"

dist: clean
	-mkdir $(LIB)-$(VERSION)
	-cp * $(LIB)-$(VERSION)
	-cd $(LIB)-$(VERSION) && make distclean && cd ..
	-tar czf $(LIB)-$(VERSION).tgz $(LIB)-$(VERSION)

distclean: clean
	-rm -f Makefile

htmldoc:
	-mandoc -Thtml $(TARGET).1 > $(TARGET).1.html

tags:
	ctags *.[ch]

man:
	@which mandoc 2>/dev/null 1>/dev/null ; if [ $$? -eq 0 ]; then \
	echo "checking manpage" ; mandoc -Tlint $(MANPAGE) ; fi

.c.o:
	$(CC) -c ${CFLAGS} $?

.PHONY: clean all install lint uninstall dist distclean htmldoc tags
